##### 一、登录模块

###### 1、发送短信验证码

- 生成随机验证码并存放到Redis中，其中key为业务前缀+当前手机号

###### 2、账号登录

- 校验短信验证码
    - 从Redis中取出验证码进行比对
- 通过校验后根据手机号查询用户是否存在
    - 不存在则进行创建
- 随机生成token作为key，并将用户信息作为value以hash的结构存入Redis中
- 登录成功，将验证码从Redis中删除，并向前端返回token
- 前端token放入请求头中，以便后端进行取值

###### 3、自定义拦截器

- 最先定义的拦截器只会拦截用户的登录页面等，如果用户长时间在列表页面，就会导致token的过期，因此需要定义另一个拦截所有路径的拦截器，用来查询用户并刷新token有效期，然后放行到最先定义的拦截器，用来查询ThreadLocal中的用户，存在则不拦截

- 拦截器一：（后定义的）
    - 拦截所有路径
    - 从请求头中获取token，token不存在则放行到第二个拦截器进行拦截
    - 基于token获取Redis中的用户信息，用户不存在则放行到第二个拦截器进行拦截
    - 将Redis中的hash数据转为userDTO对象并存放到ThreadLocal中
- 拦截器二：（最先定义的）
    - 查询ThreadLocal中的用户
    - 有用户则放行，否则拦截
- 总结：第一个拦截器用来存储用户到ThreadLocal，第二个拦截器根据ThreadLocal来拦截
- 在MVCconfig中进行配置
    - 按照添加的顺序执行拦截器
    - 也可以手动设置拦截器的顺序



##### 二、商户模块

###### 1、查询商户并进行缓存（并通过缓存空对象的方式解决缓存穿透问题）

- 根据提交的商户id去查询对应的商户
- 首先查Redis，若缓存命中
    - 空值，则返回404错误
    - 商铺信息，则返回商铺信息

- 缓存未命中则去查询数据库
    - 商户信息存在则将信息存到Redis规定TTL并返回商户信息
    - 商户信息不存在则将空值写入Redis并规定短期的TTL，使无用的空值早点过期，并返回404错误

###### 2、查询商户类型列表并进行缓存

- 同上，存在Redis中的类型也为String，感觉可以优化一下，用List或者ZSet

###### 3、更新商铺

- 查询数据库
- 因为修改了数据库，因此要删除缓存，下次缓存未命中时起到更新缓存的作用
- 单体项目，因此采用@Transactional保证数据库与缓存操作的原子性

###### 4、查询商户并进行缓存（并通过简单的锁解决缓存击穿问题）

- 通过Redis中的“如果无值则新增一个值，有值则不操作”提供的方法，作为锁
- 为了防止意外导致“锁”没有成功释放，可以给“锁”设置TTL，10s左右即可
